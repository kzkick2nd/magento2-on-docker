#!/bin/bash
cd `dirname $0`
cd ".."

docker-compose up -d

mkdir .tmp

if type composer > /dev/null 2>&1; then
        # Use composer cache if composer command is installed on local.
        composer create-project --repository=https://repo.magento.com/ magento/project-community-edition .tmp/
        mv .tmp/bin/* ./bin/
        mv .tmp/* ./ && mv .tmp/.* ./
        rm -r .tmp
else
        docker-compose exec app composer create-project --repository=https://repo.magento.com/ magento/project-community-edition .tmp/
        docker-compose exec app mv .tmp/bin/* ./bin/
        docker-compose exec app mv .tmp/* ./ && mv .tmp/.* ./
        docker-compose exec app rm -r .tmp
fi

chmod +x bin/magento

docker-compose restart

docker-compose exec app php -d memory_limit=-1 bin/magento setup:install \
        --base-url=http://127.0.0.1 \
        --db-host=db \
        --db-name=magento \
        --db-user=root \
        --db-password= \
        --backend-frontname=admin \
        --admin-firstname=admin \
        --admin-lastname=admin \
        --admin-email=admin@example.com \
        --admin-user=admin \
        --admin-password=Passw0rd! \
        --language=ja_JP \
        --currency=JPY \
        --timezone=Asia/Tokyo \
        --use-rewrites=1

open http://127.0.0.1
